```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path="www/")
library(knitr)
library(pander)
library(kableExtra)
library(datos)
suppressPackageStartupMessages(library(tidyverse))
panderOptions('table.split.table', Inf)
panderOptions('decimal.mark', ",")
panderOptions('big.mark', ".")
panderOptions('missing', "")
options(knitr.kable.NA = '')

#En libreoffice para eliminar las lineas con resultados: 
#  Reemplazar > expresiones regulares > ##.*
```

<br>

## 1.4. Gráficos con GGPLOT2

<br>

> \<cita\>Un simple gráfico ha brindado más información a la mente del analista de datos que cualquier otro dispositivo. - John Tukey\</cita\>

<br>

#### ESTRUCTURA BÁSICA DE GGPLOT2

<br>

ggplot2 es un sistema coherente para hacer gráficos.

<br>

```{r plot3, fig.width=3.2, fig.asp=4/5, fig.cap="Grafico de puntos. (plot3-1.png)"}
library(ggplot2)
ggplot(data = pressure) +  
  geom_point(mapping = aes(x = temperature, y = pressure))
```

<br>

Los componentes mínimos son:

- `ggplot` define el conjunto de datos en el parámetro `data` que debería contener todas las columnas del gráfico.
- `geom_<función>`: Define el tipo de gráfico. Por ejemplo, *geom_point* es un gráfico de puntos.
- `mapping`: define mapeo de parámetros estéticos (`x`, `y`...) a través de la función `aes()`.

<br>

A diferencia de `plot`, `ggplot` permite asignar el gráfico a un objeto R.

<br>

```{r}
p1 <- ggplot(data = pressure, mapping = aes(x = temperature, y = pressure)) +
  geom_point()
```

<br>

Posteriormente, puedes añadirle otros elementos gráficos.

<br>

```{r}
p1 <- p1 + geom_line()
```

<br>

> \<importante\>Si defines el mapeo de estéticos en `ggplot` ya no es necesario definirlos en los geoms\</importante\>

<br>

Para añadir títulos a los ejes utiliza `labs()`.

<br>

```{r}
p1 <- p1 +   labs(title = "Presión de vapor del mercurio"
                  , x = "Temperatura (ºC)", y = "Presión (mm de Hg)")
```

<br>

Para obtener el plot, ejecuta el objeto.

<br>

```{r plot4, fig.width=3.2, fig.asp=4/5, fig.cap="Grafico de líneas y puntos. (plot4-1.png)"}
p1
```

<br>

Para añadir graduación continua del color por temperatura. 

<br>

```{r plot5, fig.width=4.7, fig.asp=4/7, fig.cap="Escala de color contínua. (plot5-1.png)"}
p1 <- ggplot(data = pressure, mapping = aes(x = temperature, y = pressure
    , color = temperature)) +
  geom_point() +
  geom_line() +
  labs(title = "Presión de vapor del mercurio"
    , x = "Temperatura (ºC)", y = "Presión (mm de Hg)"
    , color = "Temperatura (ºC)")
p1
```

<br>

#### OTROS GEOMS

<br>

Otros ejemplos de geoms con los datos de países en 2007.

<br>

```{r warnings=FALSE, message=FALSE}
library(ggrepel)

paises07 <- as.data.frame(paises %>% filter(anio==2007))  # paises en 2007

p1 <- ggplot(paises07, aes(x=esperanza_de_vida)) +
  geom_histogram()

p2 <- ggplot(paises07, aes(x=continente, fill=continente)) +
  geom_bar()

p3 <- ggplot(paises07, aes(y=esperanza_de_vida, fill=continente)) +
  geom_boxplot()

p4 <- ggplot(paises07 %>% arrange(desc(esperanza_de_vida)) %>% head(25),
       aes(x=pib_per_capita, y=esperanza_de_vida)) +
  geom_point() +
  geom_label_repel(aes(label=pais), size=3)
```

<br>

```{r plot6,  echo=FALSE, fig.width=11, fig.height=5, warning=FALSE, message=FALSE, fig.cap="Galería GGPLOT2. (plot6-1.png)"}
suppressPackageStartupMessages(library(cowplot))
# arrange two plots into one column
plot_grid(p1, p2, p3, p4,
  labels = c("histograma","barras","boxplot","Etiquetas"), ncol = 2)
```

<br>

#### OTROS ELMENTOS GRÁFICOS

<br>

Otros elementos a tener en cuenta en la presentación: 

- Crear un panel de gráficos: `facet_wrap()`  y `facet_grid()` 
-	Etiquetas y anotaciones: `annotate()`, `geom_text()`, `geom_label()`, `geom_label_repel()`.
-	Valores de los ejes: `scale_x_continuous()` y `scale_x_log10()`.
- Colores: `scale_colour_discrete()`, `scale_colour_brewer()`...
-	Zoom: Importante, utiliza xlim e ylim en: `coord_cartesian()`.
-	Temas: Personalizar aspecto con `theme()`, `theme_bw()`...
- Interactivos: packages [gganimate](https://gganimate.com/),  [plotly](https://plotly.com/r/)...

<br>

Amplia la lectura en:

- [R for Data Science](https://r4ds.had.co.nz/) from Garrett Grolemund and Hadley Wickham.
- [ggplot2: Elegant Graphics for Data Analysis](https://ggplot2-book.org/) de Hadley Wickham.
- [ggplot2 extensions guide](https://exts.ggplot2.tidyverse.org/gallery/) lista los paquetes que extienden `ggplot2`.
- La [{ggplot2} cheat sheet](https://www.statsandr.com/blog/files/ggplot2-cheatsheet.pdf).

<br>

##### ACTIVIDAD GUIADA 1.3.

<br>

Mejora el Crea un resumen HTML de la esperanza_de_vida y el pib_per_capita en 2007 con la actividad guiada 1.3.

<br>

> \<sabías que\>Hans Rosling de Gapminder utilizó un gráfico muy parecido al de la actividad , añadiendo un quinto eje (el tiempo) en una famosa conferencia [TED Talk](https://www.ted.com/talks/hans_rosling_the_best_stats_you_ve_ever_seen) (14,6M de visualizaciones). Dedícale 1 minuto a ver la simulación dándole al botón de play (abajo izquierda), en el [siguiente enlace](https://www.gapminder.org/tools/#$chart-type=bubbles). La herramienta utilizada Trendalyzer fue posteriormente adquirida por Google.\</sabías que\>
